# ============================================================
# ci.yml â€” Pipeline CI principal
# DÃ©clenchÃ© sur : push dev/* + PR vers main
# Ordre : lint â†’ test:integrity (BLOQUANT) â†’ test:unit â†’ build
# ============================================================

name: ğŸŒ™ CI â€” NoorApp

on:
  push:
    branches:
      - 'dev/**'
  pull_request:
    branches:
      - main

# Annule les runs prÃ©cÃ©dents sur la mÃªme branche
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1 : Lint + TypeScript check
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: ğŸ” Lint & TypeScript
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ“¦ Installer les dÃ©pendances (quran-app)
        working-directory: apps/quran-app
        run: npm ci

      - name: ğŸ” TypeScript check
        working-directory: apps/quran-app
        run: npx tsc --noEmit

      - name: ğŸ§¹ ESLint
        working-directory: apps/quran-app
        run: npx eslint src/ --max-warnings=0

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2 : Tests d'intÃ©gritÃ© logiques (BLOQUANT, sans DB)
  # Les tests DB complets sont dans integrity-tests.yml
  # Ici : vÃ©rifications de structure + logique mÃ©tier (sans import)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test-integrity:
    name: ğŸ›¡ï¸ Tests IntÃ©gritÃ© (logique, sans DB)
    runs-on: ubuntu-latest
    # Pas de service PostgreSQL â€” les tests DB sont skippÃ©s automatiquement
    # via `describeDB = DATABASE_URL ? describe : describe.skip`

    env:
      NODE_ENV: test
      # Pas de DATABASE_URL â†’ tests DB skippÃ©s, tests logiques actifs

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ“¦ Installer les dÃ©pendances (racine)
        run: npm ci

      - name: ğŸ”§ GÃ©nÃ©rer le client Prisma
        run: npx prisma generate

      - name: ğŸ§ª Tests d'intÃ©gritÃ© logiques â€” ZONE SACRÃ‰E
        run: npm run test:ci
        # --bail activÃ© : un seul test ratÃ© = tout s'arrÃªte
        # Tests DB skippÃ©s automatiquement (pas de DATABASE_URL)

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3 : Tests unitaires (dÃ©pend de test-integrity)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test-unit:
    name: ğŸ§ª Tests Unitaires
    runs-on: ubuntu-latest
    needs: test-integrity
    # Si test:integrity Ã©choue â†’ ce job est annulÃ© automatiquement

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ“¦ Installer les dÃ©pendances (racine)
        run: npm ci

      - name: ğŸ§ª Tests unitaires
        run: npm run test:unit
        # Pas de DATABASE_URL â€” tests purement logiques (helpers, formatters, etc.)

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 4 : Build Next.js (dÃ©pend de lint + test-integrity)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ğŸ—ï¸ Build Next.js
    runs-on: ubuntu-latest
    needs: [lint, test-integrity]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ“¦ Installer les dÃ©pendances (quran-app)
        working-directory: apps/quran-app
        run: npm ci

      - name: ğŸ—ï¸ Build Next.js
        working-directory: apps/quran-app
        run: npm run build
        env:
          # Variables factices pour le build (pas de vraie DB en build)
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
          NEXT_PUBLIC_APP_NAME: NoorApp
