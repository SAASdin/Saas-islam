# ============================================================
# pr-check-sacred.yml â€” Protection des donnÃ©es islamiques sacrÃ©es
# Se dÃ©clenche quand une PR modifie des fichiers sensibles
# âš ï¸  ZONE SACRÃ‰E : toute modification nÃ©cessite 2 approvals
# ============================================================

name: ğŸ›¡ï¸ Protection DonnÃ©es SacrÃ©es

on:
  pull_request:
    branches:
      - main
    paths:
      - 'database/seeds/**'
      - 'database/integrity/**'
      - 'prisma/schema.prisma'
      - 'database/migrations/**'

jobs:
  sacred-data-check:
    name: âš ï¸ VÃ©rification Zone SacrÃ©e
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      # â”€â”€ DÃ©tecter les fichiers modifiÃ©s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Analyser les fichiers modifiÃ©s
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            database/seeds/**
            database/integrity/**
            prisma/schema.prisma
            database/migrations/**

      # â”€â”€ Poster le commentaire d'alerte â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ’¬ Poster commentaire d'alerte sur la PR
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = `${{ steps.changed-files.outputs.all_changed_files }}`.split(' ').join('\n- ');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âš ï¸ DONNÃ‰ES SACRÃ‰ES MODIFIÃ‰ES

Cette PR touche Ã  des **donnÃ©es islamiques** (Coran, Hadiths, schÃ©ma base de donnÃ©es).

**Validation des deux collaborateurs (Moha ET Bilal) obligatoire avant merge.**

### Fichiers concernÃ©s
\`\`\`
- ${changedFiles}
\`\`\`

### Checklist obligatoire pour les reviewers
- [ ] Aucun texte arabe modifiÃ© ou altÃ©rÃ©
- [ ] Aucun \`INSERT / UPDATE / DELETE\` non autorisÃ© sur les tables sacrÃ©es
- [ ] Les hashes SHA-256 dans \`database/integrity/\` sont cohÃ©rents
- [ ] Les tests d'intÃ©gritÃ© (\`npm run test:integrity\`) passent localement

> **ÙˆÙÙ…ÙØ§ ØªÙÙˆÙ’ÙÙÙŠÙ‚ÙÙŠ Ø¥ÙÙ„ÙÙ‘Ø§ Ø¨ÙØ§Ù„Ù„ÙÙ‘Ù‡Ù** â€” Cette rÃ¨gle est non-nÃ©gociable.`
            });

      # â”€â”€ Ajouter le label sacred-data-review â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ·ï¸ Ajouter le label "sacred-data-review"
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // CrÃ©er le label s'il n'existe pas
            try {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'sacred-data-review',
                color: '006400',
                description: 'âš ï¸ PR modifiant des donnÃ©es islamiques sacrÃ©es â€” 2 approvals requis'
              });
            } catch (e) {
              // Label existe dÃ©jÃ  â€” pas un problÃ¨me
            }

            // Appliquer le label Ã  la PR
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['sacred-data-review']
            });

      # â”€â”€ VÃ©rifier les hashes d'intÃ©gritÃ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” VÃ©rifier cohÃ©rence des hashes
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "VÃ©rification de la prÃ©sence des fichiers de hashes..."

          if [ -f "database/integrity/quran-hashes.json" ]; then
            QURAN_COUNT=$(cat database/integrity/quran-hashes.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(len(d))")
            echo "âœ… quran-hashes.json : $QURAN_COUNT entrÃ©es"
            if [ "$QURAN_COUNT" -ne 6236 ]; then
              echo "âŒ ERREUR : quran-hashes.json devrait contenir 6236 entrÃ©es, contient $QURAN_COUNT"
              exit 1
            fi
          else
            echo "âš ï¸  database/integrity/quran-hashes.json absent"
          fi

          if [ -f "database/integrity/hadith-hashes.json" ]; then
            HADITH_COUNT=$(cat database/integrity/hadith-hashes.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(len(d))")
            echo "âœ… hadith-hashes.json : $HADITH_COUNT entrÃ©es"
            if [ "$HADITH_COUNT" -lt 36000 ]; then
              echo "âŒ ERREUR : hadith-hashes.json devrait contenir â‰¥ 36000 entrÃ©es, contient $HADITH_COUNT"
              exit 1
            fi
          else
            echo "âš ï¸  database/integrity/hadith-hashes.json absent"
          fi

          echo "âœ… Hashes d'intÃ©gritÃ© cohÃ©rents"
