# ============================================================
# pr-check-sacred.yml â€” Protection des donnÃ©es islamiques sacrÃ©es
# Se dÃ©clenche quand une PR modifie des fichiers sensibles
# âš ï¸  ZONE SACRÃ‰E : toute modification nÃ©cessite 2 approvals
# ============================================================

name: ğŸ›¡ï¸ Protection DonnÃ©es SacrÃ©es

on:
  pull_request:
    branches:
      - main
    paths:
      - 'database/seeds/**'
      - 'database/integrity/**'
      - 'prisma/schema.prisma'
      - 'database/migrations/**'

jobs:
  sacred-data-check:
    name: âš ï¸ VÃ©rification Zone SacrÃ©e
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€ DÃ©tecter les fichiers modifiÃ©s via git diff â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” DÃ©tecter fichiers zone sacrÃ©e modifiÃ©s
        id: sacred-check
        run: |
          CHANGED=$(git diff --name-only origin/main...HEAD | grep -E \
            "^(database/seeds/|database/integrity/|prisma/schema\.prisma|database/migrations/)" \
            || true)

          if [ -n "$CHANGED" ]; then
            echo "has_sacred_changes=true" >> $GITHUB_OUTPUT
            # Encode pour usage dans le step suivant
            FILES_LIST=$(echo "$CHANGED" | head -20 | sed 's/^/- /' | tr '\n' '|')
            echo "changed_files=$FILES_LIST" >> $GITHUB_OUTPUT
            echo "âš ï¸ Fichiers sacrÃ©s modifiÃ©s dÃ©tectÃ©s :"
            echo "$CHANGED"
          else
            echo "has_sacred_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… Aucun fichier sacrÃ© modifiÃ©"
          fi

      # â”€â”€ Poster le commentaire d'alerte â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ’¬ Poster commentaire d'alerte sur la PR
        if: steps.sacred-check.outputs.has_sacred_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const rawFiles = '${{ steps.sacred-check.outputs.changed_files }}';
            const filesList = rawFiles.split('|').filter(Boolean).join('\n');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âš ï¸ DONNÃ‰ES SACRÃ‰ES MODIFIÃ‰ES

Cette PR touche Ã  des **donnÃ©es islamiques** (Coran, Hadiths, schÃ©ma base de donnÃ©es).

**Validation des deux collaborateurs (Moha ET Bilal) obligatoire avant merge.**

### Fichiers concernÃ©s
\`\`\`
${filesList}
\`\`\`

### Checklist obligatoire pour les reviewers
- [ ] Aucun texte arabe modifiÃ© ou altÃ©rÃ©
- [ ] Aucun \`INSERT / UPDATE / DELETE\` non autorisÃ© sur les tables sacrÃ©es
- [ ] Les hashes SHA-256 dans \`database/integrity/\` sont cohÃ©rents
- [ ] Les tests d\'intÃ©gritÃ© (\`npm run test:integrity\`) passent localement

> **ÙˆÙÙ…ÙØ§ ØªÙÙˆÙ’ÙÙÙŠÙ‚ÙÙŠ Ø¥ÙÙ„ÙÙ‘Ø§ Ø¨ÙØ§Ù„Ù„ÙÙ‘Ù‡Ù** â€” Cette rÃ¨gle est non-nÃ©gociable.`
            });

      # â”€â”€ Ajouter le label sacred-data-review â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ·ï¸ Ajouter le label sacred-data-review
        if: steps.sacred-check.outputs.has_sacred_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'sacred-data-review',
                color: '006400',
                description: 'PR modifiant des donnÃ©es islamiques sacrÃ©es â€” 2 approvals requis'
              });
            } catch (e) { /* label existe dÃ©jÃ  */ }

            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['sacred-data-review']
            });

      # â”€â”€ VÃ©rifier cohÃ©rence des hashes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” VÃ©rifier cohÃ©rence des hashes d'intÃ©gritÃ©
        if: steps.sacred-check.outputs.has_sacred_changes == 'true'
        run: |
          if [ -f "database/integrity/quran-hashes.json" ]; then
            COUNT=$(python3 -c "import json; d=json.load(open('database/integrity/quran-hashes.json')); print(len(d))")
            echo "âœ… quran-hashes.json : $COUNT entrÃ©es"
            [ "$COUNT" -eq 6236 ] || { echo "âŒ Attendu 6236, trouvÃ© $COUNT"; exit 1; }
          fi

          if [ -f "database/integrity/hadith-hashes.json" ]; then
            COUNT=$(python3 -c "import json; d=json.load(open('database/integrity/hadith-hashes.json')); print(len(d))")
            echo "âœ… hadith-hashes.json : $COUNT entrÃ©es"
            [ "$COUNT" -ge 36000 ] || { echo "âŒ Attendu â‰¥36000, trouvÃ© $COUNT"; exit 1; }
          fi

          echo "âœ… Hashes d'intÃ©gritÃ© cohÃ©rents"
