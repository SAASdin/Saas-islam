# ============================================================
# ci.yml â€” Pipeline CI principal
# DÃ©clenchÃ© sur : push dev/* + PR vers main
# Ordre : lint â†’ test:integrity (BLOQUANT) â†’ test:unit â†’ build
# ============================================================

name: ğŸŒ™ CI â€” NoorApp

on:
  push:
    branches:
      - 'dev/**'
  pull_request:
    branches:
      - main

# Annule les runs prÃ©cÃ©dents sur la mÃªme branche
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1 : Lint + TypeScript check
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: ğŸ” Lint & TypeScript
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ“¦ Installer les dÃ©pendances (quran-app)
        working-directory: apps/quran-app
        run: npm ci

      - name: ğŸ” TypeScript check
        working-directory: apps/quran-app
        run: npx tsc --noEmit

      - name: ğŸ§¹ ESLint
        working-directory: apps/quran-app
        run: npx eslint src/ --max-warnings=0

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2 : Tests d'intÃ©gritÃ© (BLOQUANT â€” annule tout si Ã©choue)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test-integrity:
    name: ğŸ›¡ï¸ Tests IntÃ©gritÃ© DonnÃ©es Islamiques
    runs-on: ubuntu-latest
    # Ce job ne dÃ©pend de rien â€” il peut tourner en parallÃ¨le du lint
    # mais TOUS les autres jobs en dÃ©pendent

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: ci_user
          POSTGRES_PASSWORD: ci_password
          POSTGRES_DB: saas_islam_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://ci_user:ci_password@localhost:5432/saas_islam_test
      NODE_ENV: test

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ“¦ Installer les dÃ©pendances (racine)
        run: npm ci

      - name: ğŸ”§ GÃ©nÃ©rer le client Prisma
        run: npx prisma generate

      - name: ğŸ—„ï¸ CrÃ©er le schÃ©ma DB
        run: npx prisma db push --accept-data-loss --skip-generate

      - name: ğŸŒ™ Importer le Coran (6 236 versets)
        run: npx tsx database/seeds/01-import-quran.ts
        timeout-minutes: 5

      - name: ğŸ“š Importer les hadiths (8 collections)
        run: npx tsx database/seeds/02-import-hadiths.ts
        timeout-minutes: 10

      - name: ğŸ§ª Tests d'intÃ©gritÃ© â€” ZONE SACRÃ‰E
        run: npm run test:ci
        # --bail activÃ© : un seul test ratÃ© = tout s'arrÃªte

      - name: ğŸ“Š Upload rapport d'intÃ©gritÃ©
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integrity-reports-${{ github.run_id }}
          path: |
            database/seeds/reports/
            database/integrity/
          retention-days: 30

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3 : Tests unitaires (dÃ©pend de test-integrity)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test-unit:
    name: ğŸ§ª Tests Unitaires
    runs-on: ubuntu-latest
    needs: test-integrity
    # Si test:integrity Ã©choue â†’ ce job est annulÃ© automatiquement

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ“¦ Installer les dÃ©pendances (racine)
        run: npm ci

      - name: ğŸ§ª Tests unitaires
        run: npm run test:unit
        # Pas de DATABASE_URL â€” tests purement logiques (helpers, formatters, etc.)

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 4 : Build Next.js (dÃ©pend de lint + test-integrity)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ğŸ—ï¸ Build Next.js
    runs-on: ubuntu-latest
    needs: [lint, test-integrity]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ“¦ Installer les dÃ©pendances (quran-app)
        working-directory: apps/quran-app
        run: npm ci

      - name: ğŸ—ï¸ Build Next.js
        working-directory: apps/quran-app
        run: npm run build
        env:
          # Variables factices pour le build (pas de vraie DB en build)
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
          NEXT_PUBLIC_APP_NAME: NoorApp
